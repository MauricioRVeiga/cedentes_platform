<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 fw-bold">
                <i class="fas fa-chart-line text-primary me-2"></i>Insights & Analytics
            </h1>
            <button class="btn btn-outline-primary" onclick="gerarInsightsIA()">
                <i class="fas fa-robot me-2"></i>Gerar Insights com IA
            </button>
        </div>
        <p class="text-muted">Análises e estatísticas dos seus cedentes</p>
    </div>
</div>

<!-- Estatísticas Principais -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2 opacity-75"></i>
                <h3><%= estatisticas.total || 0 %></h3>
                <p class="mb-0">Total de Cedentes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2 opacity-75"></i>
                <h3><%= estatisticas.total - estatisticas.vencidos - estatisticas.proximosVencimento %></h3>
                <p class="mb-0">Em Dia</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2 opacity-75"></i>
                <h3><%= estatisticas.proximosVencimento || 0 %></h3>
                <p class="mb-0">Próximos do Vencimento</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2 opacity-75"></i>
                <h3><%= estatisticas.vencidos || 0 %></h3>
                <p class="mb-0">Vencidos</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Status -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Distribuição por Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Gráfico de Vencimentos -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Situação de Vencimentos
                </h5>
            </div>
            <div class="card-body">
                <canvas id="vencimentosChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Insights com IA -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>Insights Inteligentes
                </h5>
            </div>
            <div class="card-body">
                <div id="insightsContent">
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Clique em "Gerar Insights com IA" para obter análises automáticas</p>
                        <button class="btn btn-primary" onclick="gerarInsightsIA()">
                            <i class="fas fa-bolt me-2"></i>Gerar Insights
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mb-0">Gerando insights...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados para os gráficos
const dadosStatus = <%= JSON.stringify(dadosGraficos.porStatus) %>;
const dadosVencimentos = <%= JSON.stringify(dadosGraficos.vencimentos) %>;

// Cores para os gráficos
const coresStatus = [
    '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#007bff', '#6c757d'
];

// Inicializar gráficos quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Pizza - Status
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'pie',
        data: {
            labels: dadosStatus.map(item => item.status),
            datasets: [{
                data: dadosStatus.map(item => item.total),
                backgroundColor: coresStatus,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Barras - Vencimentos
    const ctxVencimentos = document.getElementById('vencimentosChart').getContext('2d');
    new Chart(ctxVencimentos, {
        type: 'bar',
        data: {
            labels: ['Em Dia', 'Próximos do Vencimento', 'Vencidos'],
            datasets: [{
                label: 'Quantidade',
                data: [
                    dadosVencimentos.emDia,
                    dadosVencimentos.proximos,
                    dadosVencimentos.vencidos
                ],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});

// Função para gerar insights com IA
async function gerarInsightsIA() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    try {
        const response = await fetch('/insights/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: {
                    total: <%= estatisticas.total %>,
                    vencidos: <%= estatisticas.vencidos %>,
                    proximosVencimento: <%= estatisticas.proximosVencimento %>,
                    porStatus: dadosStatus
                }
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('insightsContent').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-robot me-2"></i>
                    <strong>Insights Gerados:</strong> ${data.observacao || 'Via IA'}
                </div>
                <div class="insights-text" style="white-space: pre-line; line-height: 1.6;">
                    ${data.insights}
                </div>
                <div class="mt-3 text-end">
                    <small class="text-muted">
                        <i class="fas fa-sync-alt me-1"></i>
                        Atualizado em ${new Date().toLocaleString('pt-BR')}
                    </small>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Erro ao gerar insights');
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('insightsContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erro ao gerar insights: ${error.message}
            </div>
        `;
    } finally {
        loadingModal.hide();
    }
}

// Gerar insights automaticamente se houver dados
<% if (estatisticas.total > 0) { %>
    setTimeout(gerarInsightsIA, 1000);
<% } %>
</script>